#!/usr/bin/env ruby
require 'rubygems'
#require 'wio'
require 'httpclient'
require 'json'

def start(args)
  host_and_path = args.pop
  raise "No host specified" unless host_and_path
  args = args.join.gsub('-', '')
  scheme = (args.include? 's') ? 'https' : 'http'
  if args.include? 'l'
    c = HTTPClient.new
    c.get_content("#{scheme}://#{host_and_path}") do |chunk|
      obj = JSON.parse(chunk)
      if obj.is_a? Array
        puts obj.first
      else
        puts chunk
      end
    end
  else
    STDIN.each_line do |line|
      begin
        obj = JSON.parse(line)
        if obj.is_a? Hash
          body = line
          headers = {"Content-Type" => "application/json"}
        elsif obj.is_a? Array
          body = obj.first.to_s
          headers = {"Content-Type" => "text/plain"}
        else 
          body = obj.to_s
          headers = {"Content-Type" => "text/plain"}
        end
      rescue JSON::ParserError
        body = line.strip
        if body.split('&').collect{|m| /^[^&^=]+=[^&^=]+$/.match(m) }.all?
          headers = {}
        else
          headers = {"Content-Type" => "text/plain"}
        end
      end
      HTTPClient.new.post("#{scheme}://#{host_and_path}", body, headers)
    end
  end
end

begin
  start(ARGV)
rescue Exception => e
  puts e
  exit
end

